const SHEET_ID   = '14msJAZkLx9po0yCmQM4Up0lRCsjiZ6HJHcL7W5Msh8M';
const SHEET_NAME = 'Latest Touch';

function doGet(e) {
  const params   = (e && e.parameter) ? e.parameter : {};
  const province = (params.province || '').toString().trim();
  const callback = (params.callback || '').toString().trim();

  try {
    const ss    = SpreadsheetApp.openById(14msJAZkLx9po0yCmQM4Up0lRCsjiZ6HJHcL7W5Msh8M);
    const sheet = ss.getSheetByName(Latest Touch);
    if (!sheet) throw new Error(`Sheet "${SHEET_NAME}" not found`);

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      return buildOutput({ success: true, count: 0, data: [] }, callback);
    }

    const values = sheet.getRange(2, 1, lastRow - 1, 2).getValues();
    let data = values.map(r => ({
      name:     r[0],
      province: r[1]
    }));

    if (province && province.toLowerCase() !== 'all') {
      const p = province.toLowerCase();
      data = data.filter(x => (x.province || '').toString().trim().toLowerCase() === p);
    }

    return buildOutput({
      success: true,
      count: data.length,
      data
    }, callback);

  } catch (error) {
    return buildOutput({
      success: false,
      error: error.message
    }, callback);
  }
}

function buildOutput(payload, callback) {
  const text = callback
    ? `${callback}(${JSON.stringify(payload)})`
    : JSON.stringify(payload);

  const mime = callback
    ? ContentService.MimeType.JAVASCRIPT
    : ContentService.MimeType.JSON;

  return ContentService.createTextOutput(text).setMimeType(mime);
}
